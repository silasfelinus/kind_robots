import{ax as x,d as C,I as w,r as $,V as P,o as U,c as p,e as y,f as s,k as A,h as m,N as i,g,t as f,W as I,X as z,a0 as V}from"./NJWOSLyt.js";const R=x("spotify",{state:()=>({token:null,track:null,playbackStatus:null,playlist:[],history:[],error:null,userProfile:null}),getters:{isPlaying(t){var e;return((e=t.playbackStatus)==null?void 0:e.isPlaying)||!1},currentTrack(t){return t.track},currentPlaylist(t){return t.playlist},trackHistory(t){return t.history}},actions:{setToken(t){this.token=t},async setVolume(t){try{if(!(await fetch(`https://api.spotify.com/v1/me/player/volume?volume_percent=${t}`,{method:"PUT",headers:{Authorization:`Bearer ${this.token}`,"Content-Type":"application/json"}})).ok)throw new Error("Failed to set volume")}catch(e){this.handleError(e)}},async fetchSpotifyToken(){try{const t=await fetch("/api/utils/spotifyToken");if(!t.ok)throw new Error(`Failed to fetch Spotify token: ${t.statusText}`);const e=await t.json();if(e.token)this.token=e.token;else throw new Error("Token not received from the server.")}catch(t){this.handleError(t)}},generateCodeVerifier(){const t=new Uint32Array(28);return window.crypto.getRandomValues(t),Array.from(t,e=>("0"+e.toString(16)).substr(-2)).join("")},async authorizeSpotify(){const t=this.generateCodeVerifier();localStorage.setItem("spotify-code-verifier",t);const e=await this.generateCodeChallenge(t),n=encodeURIComponent("user-read-private user-read-email"),r="YOUR_SPOTIFY_CLIENT_ID",h=encodeURIComponent("YOUR_REDIRECT_URI");window.location.href=`https://accounts.spotify.com/authorize?client_id=${r}&response_type=code&redirect_uri=${h}&code_challenge_method=S256&code_challenge=${e}&scope=${n}`},generateCodeChallenge(t){return crypto.subtle.digest("SHA-256",new TextEncoder().encode(t)).then(e=>btoa(String.fromCharCode.apply(null,Array.from(new Uint8Array(e)))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""))},captureSpotifyTokenFromUrl(){const t=window.location.hash.substring(1).split("&").reduce((e,n)=>{const r=n.split("=");return e[r[0]]=decodeURIComponent(r[1]),e},{});window.location.hash="",t.access_token&&(this.token=t.access_token)},updateTrackId(t){this.track&&(this.track.id=t)},async fetchCurrentUserProfile(){var t;if(!this.token){this.setError("Authentication required.");return}try{const e=await fetch("https://api.spotify.com/v1/me",{headers:{Authorization:`Bearer ${this.token}`}});if(!e.ok){const r=await e.json();throw new Error(((t=r.error)==null?void 0:t.message)||"Failed to fetch user profile.")}const n=await e.json();this.userProfile=n,console.log("User profile fetched successfully:",n)}catch(e){this.handleError(e)}},togglePlay(){this.playbackStatus&&(this.playbackStatus.isPlaying=!this.playbackStatus.isPlaying)},updatePlaybackStatus(t){this.playbackStatus=t},addToHistory(t){this.history.push(t)},async loadPlaylist(t){try{if(!this.token)throw new Error("Token is not available.");const e=await fetch(`https://api.spotify.com/v1/playlists/${t}`,{headers:{Authorization:`Bearer ${this.token}`}});if(!e.ok)throw new Error(`Failed to load playlist: ${e.statusText}`);const n=await e.json();this.playlist=n.tracks.items.map(r=>{var h,d,u,k;return{id:r.track.id,name:r.track.name,artist:((h=r.track.artists[0])==null?void 0:h.name)||"Unknown Artist",album:((d=r.track.album)==null?void 0:d.name)||"Unknown Album",release_date:((u=r.track.album)==null?void 0:u.release_date)||"Unknown Release Date",imageUrl:((k=r.track.album.images[0])==null?void 0:k.url)||""}})}catch(e){this.handleError(e)}},async playTrack(t){try{if(!this.token)throw new Error("Token is not available.");const e=await fetch("https://api.spotify.com/v1/me/player/play",{method:"PUT",headers:{Authorization:`Bearer ${this.token}`,"Content-Type":"application/json"},body:JSON.stringify({uris:[`spotify:track:${t}`]})});if(!e.ok)throw new Error(`Failed to play the track: ${e.statusText}`)}catch(e){this.handleError(e)}},async pauseTrack(){try{if(!this.token)throw new Error("Token is not available.");const t=await fetch("https://api.spotify.com/v1/me/player/pause",{method:"PUT",headers:{Authorization:`Bearer ${this.token}`}});if(!t.ok)throw new Error(`Failed to pause the track: ${t.statusText}`);this.playbackStatus&&(this.playbackStatus.isPlaying=!1)}catch(t){this.handleError(t)}},async nextTrack(){try{if(!this.token)throw new Error("Token is not available.");const t=await fetch("https://api.spotify.com/v1/me/player/next",{method:"POST",headers:{Authorization:`Bearer ${this.token}`}});if(!t.ok)throw new Error(`Failed to skip to the next track: ${t.statusText}`)}catch(t){this.handleError(t)}},async previousTrack(){try{if(!this.token)throw new Error("Token is not available.");const t=await fetch("https://api.spotify.com/v1/me/player/previous",{method:"POST",headers:{Authorization:`Bearer ${this.token}`}});if(!t.ok)throw new Error(`Failed to play the previous track: ${t.statusText}`)}catch(t){this.handleError(t)}},setError(t){this.error=t},clearError(){this.error=null},handleError(t){const e=t instanceof Error?t.message:String(t);this.setError(e),console.error("Error:",e)}}}),B={class:"bg-base-200 min-h-screen flex flex-col items-center py-8"},F={key:0,class:"mb-8"},j={key:1,class:"bg-secondary p-8 rounded shadow-lg w-1/3"},D={key:0,class:"flex items-center mb-4"},N=["src"],O={class:"text-accent font-semibold text-xl mb-1"},L={class:"text-base-100"},M={class:"flex justify-center space-x-4"},H={class:"mt-4 flex items-center"},Y={key:1,class:"mt-4"},q={class:"text-warning"},W=C({__name:"MusicToggle",setup(t){const e=R(),n=w(()=>e.token),r=w(()=>e.currentTrack),h=w(()=>e.isPlaying),d=w(()=>e.error),u=$(50),k=c=>{const o={year:"numeric",month:"short",day:"numeric"};return new Date(c).toLocaleDateString(void 0,o)},S=async c=>{try{await e.setVolume(c)}catch(o){console.error("Error setting volume",o)}};P(u,c=>{S(c)}),U(async()=>{const c=new URL(window.location.href).searchParams.get("code"),o=localStorage.getItem("spotify-code-verifier");if(c&&o)try{const a=await(await fetch(`/api/spotify-auth?code=${c}&verifier=${o}`)).json();e.setToken(a.access_token)}catch(l){console.error("Error fetching Spotify token",l)}});const{fetchSpotifyToken:v,togglePlay:b,nextTrack:T,previousTrack:_,clearError:E}=e;return(c,o)=>{const l=V;return p(),y("div",B,[n.value?g("",!0):(p(),y("div",F,[s("button",{class:"btn btn-primary",onClick:o[0]||(o[0]=(...a)=>i(v)&&i(v)(...a))},[A(" Login with Spotify "),m(l,{name:"mdi:spotify",class:"text-lg"})])])),n.value?(p(),y("div",j,[r.value?(p(),y("div",D,[s("img",{src:r.value.imageUrl,class:"w-16 h-16 rounded mr-4",alt:"Album Art"},null,8,N),s("div",null,[s("div",O,f(r.value.name),1),s("div",L,f(r.value.artist)+" - "+f(r.value.album)+" ( "+f(k(r.value.release_date))+") ",1)])])):g("",!0),s("div",M,[s("button",{class:"btn btn-accent",onClick:o[1]||(o[1]=(...a)=>i(_)&&i(_)(...a))},[m(l,{name:"mdi:skip-previous",class:"icon-size"})]),s("button",{class:"btn btn-accent",onClick:o[2]||(o[2]=(...a)=>i(b)&&i(b)(...a))},[m(l,{name:h.value?"mdi:pause":"mdi:play",class:"icon-size"},null,8,["name"])]),s("button",{class:"btn btn-accent",onClick:o[3]||(o[3]=(...a)=>i(T)&&i(T)(...a))},[m(l,{name:"mdi:skip-next",class:"icon-size"})])]),s("div",H,[m(l,{name:"mdi:volume-high",class:"text-lg mr-2"}),I(s("input",{"onUpdate:modelValue":o[4]||(o[4]=a=>u.value=a),type:"range",class:"w-full",min:"0",max:"100"},null,512),[[z,u.value]])]),d.value?(p(),y("div",Y,[s("div",q,f(d.value),1),s("button",{class:"btn btn-accent mt-2",onClick:o[5]||(o[5]=(...a)=>i(E)&&i(E)(...a))}," Clear Error ")])):g("",!0)])):g("",!0)])}}});export{W as default};
