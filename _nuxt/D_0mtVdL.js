import{_ as oe}from"./B6J_hzgV.js";import{_ as ne}from"./u0TDvN9b.js";import{ax as re,a2 as D,a4 as S,d as ce,r as b,o as le,aJ as ie,a1 as ue,I as N,aM as X,c as l,e as u,f as n,h as k,t as B,g as _,W as q,X as G,aH as Q,$ as de,F as Z,a9 as ee,n as O,k as F,Y as he,aD as ve,a0 as pe}from"./DJsSOPwi.js";import{_ as ge}from"./Q-pYmsQP.js";const _e=re({id:"chat",state:()=>({chatExchanges:[]}),actions:{getExchangeById(d){return this.chatExchanges.find(i=>i.id===d)||null},setChatExchanges(d){this.chatExchanges=d},async fetchChatExchanges(){var i;const d=D();try{const r=await(await fetch("/api/chats")).json();r.success?this.setChatExchanges(r.chatExchanges):d.setError(S.VALIDATION_ERROR,`Failed to fetch chat exchanges: ${r.message}`)}catch{d.setError(S.NETWORK_ERROR,"Network error occurred while fetching chat exchanges"),console.error(`An error occurred while fetching chat exchanges: ${(i=d.getErrors().slice(-1)[0])==null?void 0:i.message}`)}},async addOrUpdateExchange(d){var v;const i=D();try{const y=await(await fetch("/api/chats",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)})).json();y.success?this.chatExchanges.push(y.newExchange):i.setError(S.VALIDATION_ERROR,`Failed to add or update exchange: ${y.message}`)}catch{i.setError(S.NETWORK_ERROR,"Network error occurred while adding or updating an exchange"),console.error(`An error occurred while adding or updating an exchange: ${(v=i.getErrors().slice(-1)[0])==null?void 0:v.message}`)}},async addReaction(d,i){var r;const v=D();try{const R=await(await fetch(`/api/chats/${d}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})).json();if(R.success){const w=this.chatExchanges.findIndex($=>$.id===d);w!==-1&&(this.chatExchanges[w]={...this.chatExchanges[w],...i})}else v.setError(S.VALIDATION_ERROR,`Failed to add reaction: ${R.message}`)}catch{v.setError(S.NETWORK_ERROR,"Network error occurred while adding a reaction"),console.error(`An error occurred while adding a reaction: ${(r=v.getErrors().slice(-1)[0])==null?void 0:r.message}`)}}}}),me={class:"container rounded-2xl mx-auto p-2 bg-base-200"},fe={key:0,class:"avatar-container w-full m-2 rounded-lg"},be={class:"flex-grow rounded-2xl m-2 p-2 border bg-base-200"},ye={class:"flex-1 text-center"},xe={class:"text-3xl font-bold"},ke={class:"text-xl"},we={class:"card mt-2"},Ee={class:"message-container bg-base-200 p-1 rounded-2xl"},Re={class:"prompt-area p-2 rounded-2xl"},Ce={for:"newMessage",class:"block mb-2 font-bold"},Ie={key:0,class:"user-intro p-2 rounded-2xl m-2"},Se={class:"text-lg"},$e=["disabled"],Ne={key:0,class:"loader flex justify-center mt-2"},Oe={class:"reaction-buttons mt-2 flex space-x-2"},Te=["onClick"],Ae={key:0,class:"popup bg-info text-lg rounded-2xl"},je=["onClick"],Me={key:1,class:"popup bg-info text-lg rounded-2xl"},Be=["onClick"],Fe={key:2,class:"popup bg-info text-lg rounded-2xl"},De=["onClick"],Ke={key:3,class:"popup bg-info text-lg rounded-2xl"},Ve={key:0,class:"mt-2 flex items-center"},Le=["onKeyup"],Pe=["disabled","onClick"],Ue={key:0,class:"loader flex justify-center mt-2 ml-2"},Je=["onClick"],Xe=ce({__name:"StreamTest",setup(d){const i=b(!1);let v=null;le(()=>{v=localStorage.getItem("user_openai_key")});const r=b([]),y=b(null),R=ie(),w=ue(),$=_e(),c=N(()=>R.currentBot),E=b(""),C=b(""),T=b(!1),te=b(null),A=b(!1),K=N(()=>w.userId||0),V=N(()=>{var e;return((e=R.currentBot)==null?void 0:e.id)||0}),L=N(()=>{var e;return((e=R.currentBot)==null?void 0:e.name)||""}),P=N(()=>w.username),m=b({});function U(e,s,a,p,g){var x,o;const f=((x=e.find(I=>I.role==="user"))==null?void 0:x.content)??"",h=((o=e.find(I=>I.role==="assistant"))==null?void 0:o.content)??"";return{id:0,createdAt:new Date,updatedAt:new Date,botId:a,botName:p,userId:s,username:g,userPrompt:f,botResponse:h,liked:null,hated:null,loved:null,flagged:null,previousEntryId:0}}const j=(e,s)=>{const a=$.getExchangeById(e);return a==null?void 0:a[s]};X(()=>{if(r.value.length>0){const e=r.value[r.value.length-1],s=U(e,K.value,V.value,L.value,P.value);$.addOrUpdateExchange(s)}});const J=async()=>{var e,s,a,p,g;T.value=!0;try{const f=(e=c.value)!=null&&e.userIntro?`${c.value.userIntro} ${E.value}`:E.value;i.value=!0;const h=await fetch("/api/botcafe/chat",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"user",content:f}],stream:!1,user_openai_key:v})});if(!h.ok)throw new Error("Failed to send message");const x=await h.json();r.value.push([{role:"user",content:E.value,avatarImage:((s=w.user)==null?void 0:s.avatarImage)??void 0},{role:"assistant",content:x.choices[0].message.content,avatarImage:(a=c.value)==null?void 0:a.avatarImage,botName:(p=c.value)==null?void 0:p.name,subtitle:(g=c.value)==null?void 0:g.subtitle}]),E.value=""}catch(f){console.error(f),te.value="Failed to send the message. Please try again."}finally{T.value=!1}},z=async e=>{var s;A.value=!0;try{const a=r.value[e].map(h=>({...h})),p=(s=c.value)!=null&&s.userIntro?`${c.value.userIntro} ${C.value}`:C.value;a.push({role:"user",content:p});const g=await fetch("/api/botcafe/chat",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({model:"gpt-3.5-turbo",messages:a,stream:!1})});if(!g.ok)throw new Error("Failed to continue conversation");const f=await g.json();r.value[e].push({role:"user",content:C.value}),r.value[e].push({role:"assistant",content:f.choices[0].message.content}),C.value=""}catch(a){console.error(a)}finally{A.value=!1}};X(()=>{c.value&&c.value.prompt&&(E.value=c.value.prompt)});const se=e=>{r.value.splice(e,1),y.value=null},M=(e,s)=>{const a=U(r.value[e],K.value,V.value,L.value,P.value);if(a&&a.id){const p=a[s]??!1;$.addReaction(a.id,{[s]:!p})}m.value[e]||(m.value[e]={}),m.value[e][s]=!0,setTimeout(()=>{m.value[e]&&(m.value[e][s]=!1)},2e3)};return(e,s)=>{const a=oe,p=ne,g=ve,f=ge,h=pe;return l(),u("div",me,[c.value?(l(),u("div",fe,[n("div",be,[k(a),n("div",ye,[n("h1",xe,B(c.value.name??"Unknown Bot"),1),n("p",ke,B(c.value.subtitle??"Subtitle"),1),n("div",we,B(c.value.description??"Description"),1)])])])):_("",!0),n("div",Ee,[n("div",Re,[n("label",Ce,[c.value?(l(),u("div",Ie,[n("p",Se,B(c.value.userIntro??"User Intro"),1)])):_("",!0)]),q(n("textarea",{id:"newMessage","onUpdate:modelValue":s[0]||(s[0]=x=>E.value=x),rows:"5",class:"message-input w-full p-2 rounded-md border-2 resize-none",placeholder:"Type your message...",onKeyup:Q(J,["enter"])},null,544),[[G,E.value]]),n("button",{class:"submit-button btn btn-primary mt-2",disabled:T.value,onClick:J}," Send Message ",8,$e),i.value?(l(),de(p,{key:0,id:4})):_("",!0)]),T.value?(l(),u("div",Ne,[k(g)])):_("",!0),(l(!0),u(Z,null,ee(r.value,(x,o)=>{var I,W,H,Y;return l(),u("div",{key:o,class:"response-container m-2 p-4 bg-white rounded-md shadow-md relative flex flex-col items-start"},[(l(!0),u(Z,null,ee(x,(t,ae)=>(l(),u("div",{key:ae,class:O([{"flex-row-reverse":t.role==="user"},"flex items-center message-content"])},[k(f,{role:t.role,content:(t==null?void 0:t.content)??"","avatar-image":(t==null?void 0:t.avatarImage)??"/images/kindtitle.webp","bot-name":(t==null?void 0:t.botName)??"Kind Robot",subtitle:(t==null?void 0:t.subtitle)??"Your friendly neighborhood AI"},null,8,["role","content","avatar-image","bot-name","subtitle"])],2))),128)),n("div",Oe,[n("button",{class:O(["hover:bg-gray-200",{"bg-primary":j(o,"liked")}]),onClick:t=>M(o,"liked")}," 👍 ",10,Te),(I=m.value[o])!=null&&I.liked?(l(),u("div",Ae,[F(" Response Liked "),k(h,{name:"like",class:"icon-class"})])):_("",!0),n("button",{class:O(["hover:bg-gray-200",{"bg-primary":j(o,"hated")}]),onClick:t=>M(o,"hated")}," 👎 ",10,je),(W=m.value[o])!=null&&W.hated?(l(),u("div",Me,[F(" Response hated "),k(h,{name:"hate",class:"icon-class"})])):_("",!0),n("button",{class:O(["hover:bg-gray-200",{"bg-primary":j(o,"loved")}]),onClick:t=>M(o,"loved")}," ❤️ ",10,Be),(H=m.value[o])!=null&&H.loved?(l(),u("div",Fe,[F(" Favorited "),k(h,{name:"❤️",class:"icon-class"})])):_("",!0),n("button",{class:O(["hover:bg-gray-200",{"bg-primary":j(o,"flagged")}]),onClick:t=>M(o,"flagged")}," 🚩 ",10,De),(Y=m.value[o])!=null&&Y.flagged?(l(),u("div",Ke,[F(" Flagged "),k(h,{name:"🚩",class:"icon-class"})])):_("",!0)]),y.value!==null&&y.value===o?(l(),u("div",Ve,[q(n("textarea",{"onUpdate:modelValue":s[1]||(s[1]=t=>C.value=t),type:"text",rows:"3",placeholder:"Continue conversation...",class:"flex-grow p-2 rounded-md border-2 text-lg resize-y",onKeyup:Q(t=>z(o),["enter"])},null,40,Le),[[G,C.value]]),n("button",{class:"btn btn-primary ml-2",disabled:A.value,onClick:t=>z(o)}," Reply ",8,Pe),A.value?(l(),u("div",Ue,[k(g)])):_("",!0)])):_("",!0),n("button",{class:"absolute top-2 right-2 text-red-500 hover:text-red-700",onClick:he(t=>se(o),["stop"])}," × ",8,Je)])}),128))])])}}});export{Xe as _};
