import{_ as te}from"./7KWttHUF.js";import{_ as oe}from"./D92V7cIN.js";import{d as se,r as h,o as ae,aY as ne,X as le,a$ as re,G as w,b0 as X,c as r,e as c,f as n,h as f,t as M,g as p,$ as Y,a0 as G,aX as H,H as ce,F as Z,a6 as q,n as x,k as B,Z as ue,aN as ie}from"./C_jZrYmJ.js";import{_ as de}from"./Sc_sGIET.js";import ve from"./CyhNeGYF.js";const pe={class:"container rounded-2xl mx-auto p-2 bg-base-200"},_e={key:0,class:"avatar-container w-full m-2 rounded-lg"},me={class:"flex-grow rounded-2xl m-2 p-2 border bg-base-200"},he={class:"flex-1 text-center"},be={class:"text-3xl font-bold"},fe={class:"text-xl"},ge={class:"card mt-2"},ye={class:"message-container bg-base-200 p-1 rounded-2xl"},ke={class:"prompt-area p-2 rounded-2xl"},we={for:"newMessage",class:"block mb-2 font-bold"},xe={key:0,class:"user-intro p-2 rounded-2xl m-2"},Ce={class:"text-lg"},Ie=["disabled"],Se={key:0,class:"loader flex justify-center mt-2"},$e={class:"reaction-buttons mt-2 flex space-x-2"},Me=["onClick"],Be={key:0,class:"popup bg-info text-lg rounded-2xl"},Ne=["onClick"],Re={key:1,class:"popup bg-info text-lg rounded-2xl"},Ee=["onClick"],je={key:2,class:"popup bg-info text-lg rounded-2xl"},Fe=["onClick"],Te={key:3,class:"popup bg-info text-lg rounded-2xl"},Ae={key:0,class:"mt-2 flex items-center"},Ke=["onKeyup"],Ue=["disabled","onClick"],Ve={key:0,class:"loader flex justify-center mt-2 ml-2"},De=["onClick"],Ye=se({__name:"StreamTest",setup(Oe){const F=h(!1);let T=null;ae(()=>{T=localStorage.getItem("user_openai_key")});const i=h([]),N=h(null),R=ne(),E=le(),j=re(),l=w(()=>R.currentBot),g=h(""),y=h(""),C=h(!1),Q=h(null),I=h(!1),A=w(()=>E.userId||0),K=w(()=>{var e;return((e=R.currentBot)==null?void 0:e.id)||0}),U=w(()=>{var e;return((e=R.currentBot)==null?void 0:e.name)||""}),V=w(()=>E.username),_=h({});function D(e,o,s,d,v){var b,a;const m=((b=e.find(k=>k.role==="user"))==null?void 0:b.content)??"",u=((a=e.find(k=>k.role==="assistant"))==null?void 0:a.content)??"";return{id:0,createdAt:new Date,updatedAt:new Date,botId:s,botName:d,userId:o,username:v,userPrompt:m,botResponse:u,liked:null,hated:null,loved:null,flagged:null,previousEntryId:0}}const S=(e,o)=>{const s=j.getExchangeById(e);return s==null?void 0:s[o]};X(()=>{if(i.value.length>0){const e=i.value[i.value.length-1],o=D(e,A.value,K.value,U.value,V.value);j.addOrUpdateExchange(o)}});const O=async()=>{var e,o,s,d,v;C.value=!0;try{const m=(e=l.value)!=null&&e.userIntro?`${l.value.userIntro} ${g.value}`:g.value;F.value=!0;const u=await fetch("/api/botcafe/chat",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"user",content:m}],stream:!1,user_openai_key:T})});if(!u.ok)throw new Error("Failed to send message");const b=await u.json();i.value.push([{role:"user",content:g.value,avatarImage:((o=E.user)==null?void 0:o.avatarImage)??void 0},{role:"assistant",content:b.choices[0].message.content,avatarImage:(s=l.value)==null?void 0:s.avatarImage,botName:(d=l.value)==null?void 0:d.name,subtitle:(v=l.value)==null?void 0:v.subtitle}]),g.value=""}catch(m){console.error(m),Q.value="Failed to send the message. Please try again."}finally{C.value=!1}},P=async e=>{var o;I.value=!0;try{const s=i.value[e].map(u=>({...u})),d=(o=l.value)!=null&&o.userIntro?`${l.value.userIntro} ${y.value}`:y.value;s.push({role:"user",content:d});const v=await fetch("/api/botcafe/chat",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({model:"gpt-3.5-turbo",messages:s,stream:!1})});if(!v.ok)throw new Error("Failed to continue conversation");const m=await v.json();i.value[e].push({role:"user",content:y.value}),i.value[e].push({role:"assistant",content:m.choices[0].message.content}),y.value=""}catch(s){console.error(s)}finally{I.value=!1}};X(()=>{l.value&&l.value.prompt&&(g.value=l.value.prompt)});const W=e=>{i.value.splice(e,1),N.value=null},$=(e,o)=>{const s=D(i.value[e],A.value,K.value,U.value,V.value);if(s&&s.id){const d=s[o]??!1;j.addReaction(s.id,{[o]:!d})}_.value[e]||(_.value[e]={}),_.value[e][o]=!0,setTimeout(()=>{_.value[e]&&(_.value[e][o]=!1)},2e3)};return(e,o)=>{const s=te,d=oe,v=ie,m=de,u=ve;return r(),c("div",pe,[l.value?(r(),c("div",_e,[n("div",me,[f(s),n("div",he,[n("h1",be,M(l.value.name??"Unknown Bot"),1),n("p",fe,M(l.value.subtitle??"Subtitle"),1),n("div",ge,M(l.value.description??"Description"),1)])])])):p("",!0),n("div",ye,[n("div",ke,[n("label",we,[l.value?(r(),c("div",xe,[n("p",Ce,M(l.value.userIntro??"User Intro"),1)])):p("",!0)]),Y(n("textarea",{id:"newMessage","onUpdate:modelValue":o[0]||(o[0]=b=>g.value=b),rows:"5",class:"message-input w-full p-2 rounded-md border-2 resize-none",placeholder:"Type your message...",onKeyup:H(O,["enter"])},null,544),[[G,g.value]]),n("button",{class:"submit-button btn btn-primary mt-2",disabled:C.value,onClick:O}," Send Message ",8,Ie),F.value?(r(),ce(d,{key:0,id:4})):p("",!0)]),C.value?(r(),c("div",Se,[f(v)])):p("",!0),(r(!0),c(Z,null,q(i.value,(b,a)=>{var k,z,L,J;return r(),c("div",{key:a,class:"response-container m-2 p-4 bg-white rounded-md shadow-md relative flex flex-col items-start"},[(r(!0),c(Z,null,q(b,(t,ee)=>(r(),c("div",{key:ee,class:x([{"flex-row-reverse":t.role==="user"},"flex items-center message-content"])},[f(m,{role:t.role,content:(t==null?void 0:t.content)??"","avatar-image":(t==null?void 0:t.avatarImage)??"/images/kindtitle.webp","bot-name":(t==null?void 0:t.botName)??"Kind Robot",subtitle:(t==null?void 0:t.subtitle)??"Your friendly neighborhood AI"},null,8,["role","content","avatar-image","bot-name","subtitle"])],2))),128)),n("div",$e,[n("button",{class:x(["hover:bg-gray-200",{"bg-primary":S(a,"liked")}]),onClick:t=>$(a,"liked")}," 👍 ",10,Me),(k=_.value[a])!=null&&k.liked?(r(),c("div",Be,[B(" Response Liked "),f(u,{name:"like",class:"icon-class"})])):p("",!0),n("button",{class:x(["hover:bg-gray-200",{"bg-primary":S(a,"hated")}]),onClick:t=>$(a,"hated")}," 👎 ",10,Ne),(z=_.value[a])!=null&&z.hated?(r(),c("div",Re,[B(" Response hated "),f(u,{name:"hate",class:"icon-class"})])):p("",!0),n("button",{class:x(["hover:bg-gray-200",{"bg-primary":S(a,"loved")}]),onClick:t=>$(a,"loved")}," ❤️ ",10,Ee),(L=_.value[a])!=null&&L.loved?(r(),c("div",je,[B(" Favorited "),f(u,{name:"❤️",class:"icon-class"})])):p("",!0),n("button",{class:x(["hover:bg-gray-200",{"bg-primary":S(a,"flagged")}]),onClick:t=>$(a,"flagged")}," 🚩 ",10,Fe),(J=_.value[a])!=null&&J.flagged?(r(),c("div",Te,[B(" Flagged "),f(u,{name:"🚩",class:"icon-class"})])):p("",!0)]),N.value!==null&&N.value===a?(r(),c("div",Ae,[Y(n("textarea",{"onUpdate:modelValue":o[1]||(o[1]=t=>y.value=t),type:"text",rows:"3",placeholder:"Continue conversation...",class:"flex-grow p-2 rounded-md border-2 text-lg resize-y",onKeyup:H(t=>P(a),["enter"])},null,40,Ke),[[G,y.value]]),n("button",{class:"btn btn-primary ml-2",disabled:I.value,onClick:t=>P(a)}," Reply ",8,Ue),I.value?(r(),c("div",Ve,[f(v)])):p("",!0)])):p("",!0),n("button",{class:"absolute top-2 right-2 text-red-500 hover:text-red-700",onClick:ue(t=>W(a),["stop"])}," × ",8,De)])}),128))])])}}});export{Ye as _};
